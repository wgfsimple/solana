<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fork Selection - Solana: Blockchain Rebuilt for Scale</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Lato:300,400|Poppins:300,400" rel="stylesheet">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <img src="https://manuel-calavera.github.io/images/logo.png" alt="">
            <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="terminology.html"><strong aria-hidden="true">2.</strong> Terminology</a></li><li><a href="getting-started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li><ol class="section"><li><a href="webwallet.html"><strong aria-hidden="true">3.1.</strong> Example: Web Wallet</a></li></ol></li><li><a href="programs.html"><strong aria-hidden="true">4.</strong> Programming Model</a></li><li><ol class="section"><li><a href="tictactoe.html"><strong aria-hidden="true">4.1.</strong> Example: Tic-Tac-Toe</a></li><li><a href="drones.html"><strong aria-hidden="true">4.2.</strong> Drones</a></li></ol></li><li><a href="cluster.html"><strong aria-hidden="true">5.</strong> A Solana Cluster</a></li><li><ol class="section"><li><a href="synchronization.html"><strong aria-hidden="true">5.1.</strong> Synchronization</a></li><li><a href="leader-rotation.html"><strong aria-hidden="true">5.2.</strong> Leader Rotation</a></li><li><a href="fork-generation.html"><strong aria-hidden="true">5.3.</strong> Fork Generation</a></li></ol></li><li><a href="fullnode.html"><strong aria-hidden="true">6.</strong> Anatomy of a Fullnode</a></li><li><ol class="section"><li><a href="tpu.html"><strong aria-hidden="true">6.1.</strong> TPU</a></li><li><a href="tvu.html"><strong aria-hidden="true">6.2.</strong> TVU</a></li><li><a href="gossip.html"><strong aria-hidden="true">6.3.</strong> Gossip Service</a></li><li><a href="runtime.html"><strong aria-hidden="true">6.4.</strong> The Runtime</a></li></ol></li><li><a href="proposals.html"><strong aria-hidden="true">7.</strong> Proposed Architectural Changes</a></li><li><ol class="section"><li><a href="ledger-replication.html"><strong aria-hidden="true">7.1.</strong> Ledger Replication</a></li><li><a href="enclave.html"><strong aria-hidden="true">7.2.</strong> Secure Enclave</a></li><li><a href="staking-rewards.html"><strong aria-hidden="true">7.3.</strong> Staking Rewards</a></li><li><a href="fork-selection.html" class="active"><strong aria-hidden="true">7.4.</strong> Fork Selection</a></li><li><a href="entry-tree.html"><strong aria-hidden="true">7.5.</strong> Entry Tree</a></li></ol></li><li><a href="appendix.html"><strong aria-hidden="true">8.</strong> Appendix</a></li><li><ol class="section"><li><a href="jsonrpc-api.html"><strong aria-hidden="true">8.1.</strong> JSON RPC API</a></li><li><a href="javascript-api.html"><strong aria-hidden="true">8.2.</strong> JavaScript API</a></li><li><a href="wallet.html"><strong aria-hidden="true">8.3.</strong> solana-wallet CLI</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            
                            
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Solana: Blockchain Rebuilt for Scale</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#fork-selection" id="fork-selection"><h1>Fork Selection</h1></a>
<p>This article describes Solana's <em>Nakomoto Fork Selection</em> algorithm based on time
locks. It satisfies the following properties:</p>
<ul>
<li>A voter can eventually recover from voting on a fork that doesn't become the
fork with the desired network finality.</li>
<li>If the voters share a common ancestor then they will converge to a fork
containing that ancestor no matter how they are partitioned. The converged
ancestor may not be the latest possible ancestor at the start of the fork.</li>
<li>Rollback requires exponentially more time for older votes than for newer
votes.</li>
<li>Voters have the freedom to set a minimum network confirmation threshold
before committing a vote to a higher lockout.  This allows each voter to make
a trade-off between risk and reward. See <a href="#cost-of-rollback">cost of rollback</a>.</li>
</ul>
<a class="header" href="#time" id="time"><h2>Time</h2></a>
<p>For networks like Solana, time can be the PoH hash count, which is a VDF that
provides a source of time before consensus. Other networks adopting this
approach would need to consider a global source of time.</p>
<p>For Solana, time uniquely identifies a specific leader for fork generation.  At
any given time only 1 leader, which can be computed from the ledger itself, can
propose a fork.  For more details, see <a href="fork-generation.html">fork generation</a>
and <a href="leader-rotation.html">leader rotation</a>.</p>
<a class="header" href="#algorithm" id="algorithm"><h2>Algorithm</h2></a>
<p>The basic idea to this approach is to stack consensus votes.  Each vote in the
stack is a confirmation of a fork.  Each confirmed fork is an ancestor of the
fork above it.  Each consensus vote has a <code>lockout</code> in units of time before the
validator can submit a vote that does not contain the confirmed fork as an
ancestor.</p>
<p>When a vote is added to the stack, the lockouts of all the previous votes in
the stack are doubled (more on this in <a href="#Rollback">Rollback</a>).  With each new
vote, a voter commits the previous votes to an ever-increasing lockout.  At 32
votes we can consider the vote to be at <code>max lockout</code> any votes with a lockout
equal to or above <code>1&lt;&lt;32</code> are dequeued (FIFO).  Dequeuing a vote is the trigger
for a reward.  If a vote expires before it is dequeued, it and all the votes
above it are popped (LIFO) from the vote stack.  The voter needs to start
rebuilding the stack from that point.</p>
<a class="header" href="#rollback" id="rollback"><h3>Rollback</h3></a>
<p>Before a vote is pushed to the stack, all the votes leading up to vote with a
lower lock time than the new vote are popped.  After rollback lockouts are not
doubled until the voter catches up to the rollback height of votes.</p>
<p>For example, a vote stack with the following state:</p>
<table><thead><tr><th align="right"> vote </th><th align="right"> vote time </th><th align="right"> lockout </th><th align="right"> lock expiration time </th></tr></thead><tbody>
<tr><td align="right">    4 </td><td align="right">         4 </td><td align="right">      2  </td><td align="right">                    6 </td></tr>
<tr><td align="right">    3 </td><td align="right">         3 </td><td align="right">      4  </td><td align="right">                    7 </td></tr>
<tr><td align="right">    2 </td><td align="right">         2 </td><td align="right">      8  </td><td align="right">                   10 </td></tr>
<tr><td align="right">    1 </td><td align="right">         1 </td><td align="right">      16 </td><td align="right">                   17 </td></tr>
</tbody></table>
<p><em>Vote 5</em> is at time 9, and the resulting state is</p>
<table><thead><tr><th> vote </th><th> vote time </th><th> lockout </th><th> lock expiration time </th></tr></thead><tbody>
<tr><td align="right">    5 </td><td align="right">         9 </td><td align="right">      2  </td><td align="right">                   11 </td></tr>
<tr><td align="right">    2 </td><td align="right">         2 </td><td align="right">      8  </td><td align="right">                   10 </td></tr>
<tr><td align="right">    1 </td><td align="right">         1 </td><td align="right">      16 </td><td align="right">                   17 </td></tr>
</tbody></table>
<p><em>Vote 6</em> is at time 10</p>
<table><thead><tr><th> vote </th><th> vote time </th><th> lockout </th><th> lock expiration time </th></tr></thead><tbody>
<tr><td align="right">    6 </td><td align="right">        10 </td><td align="right">       2 </td><td align="right">                   12 </td></tr>
<tr><td align="right">    5 </td><td align="right">         9 </td><td align="right">       4 </td><td align="right">                   13 </td></tr>
<tr><td align="right">    2 </td><td align="right">         2 </td><td align="right">       8 </td><td align="right">                   10 </td></tr>
<tr><td align="right">    1 </td><td align="right">         1 </td><td align="right">      16 </td><td align="right">                   17 </td></tr>
</tbody></table>
<p>At time 10 the new votes caught up to the previous votes.  But <em>vote 2</em> expires
at 10, so the when <em>vote 7</em> at time 11 is applied the votes including and above
<em>vote 2</em> will be popped.</p>
<table><thead><tr><th> vote </th><th> vote time </th><th> lockout </th><th> lock expiration time </th></tr></thead><tbody>
<tr><td align="right">    7 </td><td align="right">        11 </td><td align="right">       2 </td><td align="right">                   13 </td></tr>
<tr><td align="right">    1 </td><td align="right">         1 </td><td align="right">      16 </td><td align="right">                   17 </td></tr>
</tbody></table>
<p>The lockout for vote 1 will not increase from 16 until the stack contains 5
votes.</p>
<a class="header" href="#slashing-and-rewards" id="slashing-and-rewards"><h3>Slashing and Rewards</h3></a>
<p>The purpose of the lockout is to force a voter to commit opportunity cost to a
specific fork.  Voters that violate the lockouts and vote for a diverging fork
within the lockout should be punished.  Slashing or simply freezing the voter
from rewards for a long period of time can be used as punishment.</p>
<p>Voters should be rewarded for selecting the fork that the rest of the network
selected as often as possible.  This is well-aligned with generating a reward
when the vote stack is full and the oldest vote needs to be dequeued.  Thus a
reward should be generated for each successful dequeue.</p>
<a class="header" href="#cost-of-rollback" id="cost-of-rollback"><h3>Cost of Rollback</h3></a>
<p>Cost of rollback of <em>fork A</em> is defined as the cost in terms of lockout time to
the validators to confirm any other fork that does not include <em>fork A</em> as an
ancestor.</p>
<p>The <strong>Economic Finality</strong> of <em>fork A</em> can be calculated as the loss of all the
rewards from rollback of <em>fork A</em> and its descendants, plus the opportunity
cost of reward due to the exponentially growing lockout of the votes that have
confirmed <em>fork A</em>.</p>
<a class="header" href="#thresholds" id="thresholds"><h3>Thresholds</h3></a>
<p>Each voter can independently set a threshold of network commitment to a fork
before that voter commits to a fork.  For example, at vote stack index 7, the
lockout is 256 time units.  A voter may withhold votes and let votes 0-7 expire
unless the vote at index 7 has at greater than 50% commitment in the network.
This allows each voter to independently control how much risk to commit to a
fork.  Committing to forks at a higher frequency would allow the voter to earn
more rewards.</p>
<a class="header" href="#algorithm-parameters" id="algorithm-parameters"><h3>Algorithm parameters</h3></a>
<p>These parameters need to be tuned.</p>
<ul>
<li>Number of votes in the stack before dequeue occurs (32).</li>
<li>Rate of growth for lockouts in the stack (2x).</li>
<li>Starting default lockout (2).</li>
<li>Threshold depth for minimum network commitment before committing to the fork
(8).</li>
<li>Minimum network commitment size at threshold depth (50%+).</li>
</ul>
<a class="header" href="#free-choice" id="free-choice"><h3>Free Choice</h3></a>
<p>A &quot;Free Choice&quot; is an unenforcible voter action.  A voter that maximizes
self-reward over all possible futures should behave in such a way that the
system is stable, and the local greedy choice should result in a greedy choice
over all possible futures.  A set of voter that are engaging in choices to
disrupt the protocol should be bound by their stake weight to the denial of
service.  Two options exits for voter:</p>
<ul>
<li>a voter can outrun previous voters in virtual generation and submit a
concurrent fork</li>
<li>a voter can withhold a vote to observe multiple forks before voting</li>
</ul>
<p>In both cases, the voters in the network have several forks to pick from
concurrently, even though each fork represents a different height.  In both
cases it is impossible for the protocol to detect if the voter behavior is
intentional or not.</p>
<a class="header" href="#greedy-choice-for-concurrent-forks" id="greedy-choice-for-concurrent-forks"><h3>Greedy Choice for Concurrent Forks</h3></a>
<p>When evaluating multiple forks, each voter should pick the fork that will
maximize economic finality for the network, or the latest fork if all are equal.</p>

                    </main>
                </div>
            </div>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
