<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fork Generation - Solana: Blockchain Rebuilt for Scale</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Lato:300,400|Poppins:300,400" rel="stylesheet">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <img src="https://manuel-calavera.github.io/images/logo.png" alt="">
            <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="terminology.html"><strong aria-hidden="true">2.</strong> Terminology</a></li><li><a href="getting-started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li><ol class="section"><li><a href="webwallet.html"><strong aria-hidden="true">3.1.</strong> Example: Web Wallet</a></li></ol></li><li><a href="programs.html"><strong aria-hidden="true">4.</strong> Programming Model</a></li><li><ol class="section"><li><a href="tictactoe.html"><strong aria-hidden="true">4.1.</strong> Example: Tic-Tac-Toe</a></li><li><a href="drones.html"><strong aria-hidden="true">4.2.</strong> Drones</a></li></ol></li><li><a href="cluster.html"><strong aria-hidden="true">5.</strong> A Solana Cluster</a></li><li><ol class="section"><li><a href="synchronization.html"><strong aria-hidden="true">5.1.</strong> Synchronization</a></li><li><a href="leader-rotation.html"><strong aria-hidden="true">5.2.</strong> Leader Rotation</a></li><li><a href="fork-generation.html" class="active"><strong aria-hidden="true">5.3.</strong> Fork Generation</a></li></ol></li><li><a href="fullnode.html"><strong aria-hidden="true">6.</strong> Anatomy of a Fullnode</a></li><li><ol class="section"><li><a href="tpu.html"><strong aria-hidden="true">6.1.</strong> TPU</a></li><li><a href="tvu.html"><strong aria-hidden="true">6.2.</strong> TVU</a></li><li><a href="gossip.html"><strong aria-hidden="true">6.3.</strong> Gossip Service</a></li><li><a href="runtime.html"><strong aria-hidden="true">6.4.</strong> The Runtime</a></li></ol></li><li><a href="proposals.html"><strong aria-hidden="true">7.</strong> Proposed Architectural Changes</a></li><li><ol class="section"><li><a href="ledger-replication.html"><strong aria-hidden="true">7.1.</strong> Ledger Replication</a></li><li><a href="enclave.html"><strong aria-hidden="true">7.2.</strong> Secure Enclave</a></li><li><a href="staking-rewards.html"><strong aria-hidden="true">7.3.</strong> Staking Rewards</a></li><li><a href="fork-selection.html"><strong aria-hidden="true">7.4.</strong> Fork Selection</a></li><li><a href="entry-tree.html"><strong aria-hidden="true">7.5.</strong> Entry Tree</a></li></ol></li><li><a href="appendix.html"><strong aria-hidden="true">8.</strong> Appendix</a></li><li><ol class="section"><li><a href="jsonrpc-api.html"><strong aria-hidden="true">8.1.</strong> JSON RPC API</a></li><li><a href="javascript-api.html"><strong aria-hidden="true">8.2.</strong> JavaScript API</a></li><li><a href="wallet.html"><strong aria-hidden="true">8.3.</strong> solana-wallet CLI</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            
                            
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Solana: Blockchain Rebuilt for Scale</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#fork-generation" id="fork-generation"><h1>Fork Generation</h1></a>
<p>The chapter describes how forks naturally occur as a consequence of <a href="leader-rotation.html">leader
rotation</a>.</p>
<a class="header" href="#overview" id="overview"><h2>Overview</h2></a>
<p>Nodes take turns being leader and generating the PoH that encodes state
changes.  The cluster can tolerate loss of connection to any leader by
synthesizing what the leader <strong><em>would</em></strong> have generated had it been connected
but not ingesting any state changes.  The possible number of forks is thereby
limited to a &quot;there/not-there&quot; skip list of forks that may arise on leader
rotation slot boundaries.  At any given slot, only a single leader's
transactions will be accepted.</p>
<a class="header" href="#message-flow" id="message-flow"><h2>Message Flow</h2></a>
<ol>
<li>Transactions are ingested by the current leader.</li>
<li>Leader filters valid transactions.</li>
<li>Leader executes valid transactions updating its state.</li>
<li>Leader packages transactions into entries based off its current PoH slot.</li>
<li>Leader transmits the entries to validator nodes (in signed blobs)
<ol>
<li>The PoH stream includes ticks; empty entries that indicate liveness of
the leader and the passage of time on the cluster.</li>
<li>A leader's stream begins with the tick entries necessary complete the PoH
back to the leaders most recently observed prior leader slot.</li>
</ol>
</li>
<li>Validators retransmit entries to peers in their set and to further
downstream nodes.</li>
<li>Validators validate the transactions and execute them on their state.</li>
<li>Validators compute the hash of the state.</li>
<li>At specific times, i.e. specific PoH tick counts, validators transmit votes
to the leader.
<ol>
<li>Votes are signatures of the hash of the computed state at that PoH tick
count</li>
<li>Votes are also propagated via gossip</li>
</ol>
</li>
<li>Leader executes the votes as any other transaction and broadcasts them to
the cluster.</li>
<li>Validators observe their votes and all the votes from the cluster.</li>
</ol>
<a class="header" href="#partitions-forks" id="partitions-forks"><h2>Partitions, Forks</h2></a>
<p>Forks can arise at PoH tick counts that correspond to a vote.  The next leader
may not have observed the last vote slot and may start their slot with
generated virtual PoH entries.  These empty ticks are generated by all nodes in
the cluster at a cluster-configured rate for hashes/per/tick <code>Z</code>.</p>
<p>There are only two possible versions of the PoH during a voting slot: PoH with
<code>T</code> ticks and entries generated by the current leader, or PoH with just ticks.
The &quot;just ticks&quot; version of the PoH can be thought of as a virtual ledger, one
that all nodes in the cluster can derive from the last tick in the previous
slot.</p>
<p>Validators can ignore forks at other points (e.g. from the wrong leader), or
slash the leader responsible for the fork.</p>
<p>Validators vote based on a greedy choice to maximize their reward described in
<a href="fork-selection.html">forks selection</a>.</p>
<a class="header" href="#validators-view" id="validators-view"><h3>Validator's View</h3></a>
<a class="header" href="#time-progression-the-diagram-below-represents-a-validators-view-of-the" id="time-progression-the-diagram-below-represents-a-validators-view-of-the"><h4>Time Progression The diagram below represents a validator's view of the</h4></a>
<p>PoH stream with possible forks over time.  L1, L2, etc. are leader slot, and
<code>E</code>s represent entries from that leader during that leader's slot.  The 'x's
represent ticks only, and time flows downwards in the diagram.</p>
<p><img alt="Fork generation" src="img/fork-generation.svg" class="center"/></p>
<p>Note that an <code>E</code> appearing on 2 forks at the same slot is a slashable
condition, so a validator observing <code>E3</code> and <code>E3'</code> can slash L3 and safely
choose <code>x</code> for that slot.  Once a validator commits to a forks, other forks can
be discarded below that tick count.  For any slot, validators need only
consider a single &quot;has entries&quot; chain or a &quot;ticks only&quot; chain to be proposed by
a leader.  But multiple virtual entries may overlap as they link back to the a
previous slot.</p>
<a class="header" href="#time-division" id="time-division"><h4>Time Division</h4></a>
<p>It's useful to consider leader rotation over PoH tick count as time division of
the job of encoding state for the cluster.  The following table presents the
above tree of forks as a time-divided ledger.</p>
<table><thead><tr><th>leader slot </th><th>  L1 </th><th> L2 </th><th> L3 </th><th> L4 </th><th> L5</th></tr></thead><tbody>
<tr><td>data      </td><td>  E1</td><td> E2 </td><td> E3 </td><td> E4  </td><td> E5</td></tr>
<tr><td>ticks since prev  </td><td> </td><td> </td><td> </td><td> x </td><td> xx</td></tr>
</tbody></table>
<p>Note that only data from leader L3 will be accepted during leader slot L3.
Data from L3 may include &quot;catchup&quot; ticks back to a slot other than L2 if L3 did
not observe L2's data.  L4 and L5's transmissions include the &quot;ticks to prev&quot;
PoH entries.</p>
<p>This arrangement of the network data streams permits nodes to save exactly this
to the ledger for replay, restart, and checkpoints.</p>
<a class="header" href="#leaders-view" id="leaders-view"><h3>Leader's View</h3></a>
<p>When a new leader begins a slot, it must first transmit any PoH (ticks)
required to link the new slot with the most recently observed and voted slot.
The fork the leader proposes would link the current slot to a previous fork
that the leader has voted on with virtual ticks.</p>

                    </main>
                </div>
            </div>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
